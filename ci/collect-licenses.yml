collect-licenses:
  stage: test
  image: docker:20.10.7@sha256:bfc499cef26daa22da31b76be1752813a6921ee1fa1dd1f56d4fdf19c701d332
  needs:
    - job: build-docker
      artifacts: false
    - job: npm-install
      artifacts: false
  variables:
    GIT_DEPTH: '1'
  script:
    - export DOCKERFILE=license-collector.dockerfile
    - echo "" > $DOCKERFILE
    # it is (currently) not possible to use a variable inside the mount of a RUN.
    - >
      for JOB in $JOBS_INSTALL; do
        echo "FROM $CI_REGISTRY/pia/$JOB-npm-install:$IMAGE_ID as $JOB-npm-install" >> $DOCKERFILE
      done
    - echo "FROM $CI_REGISTRY/pia/psa.utils.repo-tool:$IMAGE_ID AS base" >> $DOCKERFILE
    - echo "RUN \\" >> $DOCKERFILE
    - >
      for JOB in $JOBS_INSTALL; do
        echo "  --mount=type=bind,ro,from=$JOB-npm-install,source=/usr/src/node-app,target=/usr/src/$JOB \\" >> $DOCKERFILE
      done
    - echo "  REPO_DIR=/dependencies OUT_FILE=/licenses.csv npm run license" >> $DOCKERFILE
    - echo "FROM scratch" >> $DOCKERFILE
    - echo "COPY --from=base /licenses.csv /" >> $DOCKERFILE
    - DOCKER_BUILDKIT=1 docker build -f $DOCKERFILE -o . .
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH =~ /^develop/
    - if: $CI_COMMIT_BRANCH =~ /^release/
  artifacts:
    paths:
      - licenses.csv
