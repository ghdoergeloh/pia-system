collect-licenses:
  stage: test
  image: docker:20.10.7@sha256:bfc499cef26daa22da31b76be1752813a6921ee1fa1dd1f56d4fdf19c701d332
  needs:
    - job: build-docker
      artifacts: false
    - job: npm-install
      artifacts: false
  variables:
    GIT_DEPTH: '1'
  script:
    - sh -c "docker login -u '$CI_REGISTRY_USER' -p '$CI_REGISTRY_PASSWORD' '$CI_REGISTRY'"
    - DOCKER_BUILDKIT=1 docker build -f psa.utils.repo-tool/generated/license-collector.dockerfile -o . --build-arg VERSION=$IMAGE_ID .
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH =~ /^develop/
    - if: $CI_COMMIT_BRANCH =~ /^release/
  artifacts:
    paths:
      - licenses.csv
