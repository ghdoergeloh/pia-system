check-sonarqube-feature:
  stage: push
  image:
    name: sonarsource/sonar-scanner-cli:4.6@sha256:c782340526ea4fc21226dd325da7724beb130ff756b53583387dd6aca26d3a59
    entrypoint: ['']
  needs:
    - job: accumulate-coverage
      artifacts: true
  variables:
    GIT_DEPTH: 1
    GIT_STRATEGY: clone
    SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar' # Defines the location of the analysis task cache
  cache:
    key: '${CI_JOB_NAME}'
    paths:
      - .sonar/cache
  script:
    - find . -name tsconfig.json -exec sed -i "s/@pia\/lib-service-core/..\/psa.lib.service-core\/tsconfig.global.json/g" {} \;
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_LOGIN_TOKEN_FEATURE
      -Dsonar.projectKey=pia-system-feature
      -Dsonar.sources=.
      -Dsonar.inclusions=**/src/**
      -Dsonar.exclusions=psa.utils.*/**,psa.test.*/**,coverage/**
      -Dsonar.test.inclusions=**/*.spec.*,**/tests/**,psa.app.*/e2e/**,psa.app.*/cypress/**
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.coverage.exclusions=*service*/src/index.*
      -Dsonar.qualitygate.wait=true
  rules:
    - if: '$CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^develop/'
  resource_group: sonarqube

check-sonarqube-develop:
  stage: push
  image:
    name: sonarsource/sonar-scanner-cli:4.6@sha256:c782340526ea4fc21226dd325da7724beb130ff756b53583387dd6aca26d3a59
    entrypoint: ['']
  needs:
    - job: accumulate-coverage
      artifacts: true
  variables:
    GIT_DEPTH: 0
    SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar' # Defines the location of the analysis task cache
  cache:
    key: '${CI_JOB_NAME}'
    paths:
      - .sonar/cache
  script:
    - git fetch --unshallow || true
    - find . -name tsconfig.json -exec sed -i "s/@pia\/lib-service-core/..\/psa.lib.service-core\/tsconfig.global.json/g" {} \;
    # create new base version for new code in feature-branch project
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_LOGIN_TOKEN_FEATURE
      -Dsonar.projectKey=pia-system-feature
      -Dsonar.sources=.
      -Dsonar.inclusions=**/src/**
      -Dsonar.exclusions=psa.utils.*/**,psa.test.*/**,coverage/**
      -Dsonar.test.inclusions=**/*.spec.*,**/tests/**,psa.app.*/e2e/**,psa.app.*/cypress/**
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.coverage.exclusions=*service*/src/index.*
      -Dsonar.projectVersion=develop.$CI_PIPELINE_ID
    # create new floating version new code in feature-branch project
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_LOGIN_TOKEN_FEATURE
      -Dsonar.projectKey=pia-system-feature
      -Dsonar.sources=.
      -Dsonar.inclusions=**/src/**
      -Dsonar.exclusions=psa.utils.*/**,psa.test.*/**,coverage/**
      -Dsonar.test.inclusions=**/*.spec.*,**/tests/**,psa.app.*/e2e/**,psa.app.*/cypress/**
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.coverage.exclusions=*service*/src/index.*
      -Dsonar.projectVersion=feature.$CI_PIPELINE_ID
    # scann for develop
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_LOGIN_TOKEN_DEVELOP
      -Dsonar.projectKey=pia-system-develop
      -Dsonar.sources=.
      -Dsonar.inclusions=**/src/**
      -Dsonar.exclusions=psa.utils.*/**,psa.test.*/**,coverage/**
      -Dsonar.test.inclusions=**/*.spec.*,**/tests/**,psa.app.*/e2e/**,psa.app.*/cypress/**
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.coverage.exclusions=*service*/src/index.*
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^develop/
  resource_group: sonarqube

check-sonarqube-release:
  stage: push
  image:
    name: sonarsource/sonar-scanner-cli:4.6@sha256:c782340526ea4fc21226dd325da7724beb130ff756b53583387dd6aca26d3a59
    entrypoint: ['']
  needs:
    - job: accumulate-coverage
      artifacts: true
  variables:
    GIT_DEPTH: 0
    SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar' # Defines the location of the analysis task cache
  cache:
    key: '${CI_JOB_NAME}'
    paths:
      - .sonar/cache
  script:
    - git fetch --unshallow || true
    - find . -name tsconfig.json -exec sed -i "s/@pia\/lib-service-core/..\/psa.lib.service-core\/tsconfig.global.json/g" {} \;
    - sonar-scanner
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.login=$SONAR_LOGIN_TOKEN_RELEASE
      -Dsonar.projectKey=pia-system-release
      -Dsonar.sources=.
      -Dsonar.inclusions=**/src/**
      -Dsonar.exclusions=psa.utils.*/**,psa.test.*/**,coverage/**
      -Dsonar.test.inclusions=**/*.spec.*,**/tests/**,psa.app.*/e2e/**,psa.app.*/cypress/**
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      -Dsonar.coverage.exclusions=*service*/src/index.*
      -Dsonar.qualitygate.wait=true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG
